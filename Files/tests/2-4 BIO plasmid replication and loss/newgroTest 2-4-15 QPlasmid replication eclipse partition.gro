/*To study in detail the split of active and eclipse copies during cell division. Synchronized cells.
To test:
 - Use exact and stochastic partition, with and without vol scaling
 - Use different eclipse times
*/

include gro3

copyNum := 20.0;
iniCopies := 20.0;

//autoVol := "none";
autoVol := "division";

//deathGate := "bga_notInitial";
deathGate := "_ga_false";

//selectedStrain := "str_wt";
selectedStrain := "str_synchro";

partitionGate := "_ga_true";
//partitionGate := "_ga_false";

partP := { 0.5, 0.0 };
partFraction := { 0.5, 0.0 };
volScaling := false;


global_params([ seed := 133087, show_plots := true, sensitivity := 0.0001 ]);


//----------------------BIOCIRCUITS---------------------------
//---cells
bplasmid([ name := "bp_initial", loss_prob := 1.0 ]);
bgate([ name := "bga_notInitial", input := {"-bp_initial"} ]);
strain([ name := "str_wt", death_gate := deathGate, death_threshold := 10.0, growth_rate := { 0.01, 0.0 } ]);
strain([ name := "str_synchro", death_gate := deathGate, death_threshold := 10.0, growth_rate := { 0.01, 0.0 }, ini_vol := 1.5, division_vol := 3.0, division_fraction := 0.5 ]);

cell_type([ name := "cell_A"
	, strain := selectedStrain
	, qplasmids := {"qp_A"} 
	, qplasmid_amounts := { iniCopies }
	//, qplasmids_as_concs := false
	, bplasmids := { "bp_initial" } 
]);


//---replication
copy_control([ name := "cc_A", gate := "_ga_true", w := 0.01 ]);

function([ name := "fun_qpAall", input := { "qp_A", "qp_A_eclipse" }, auto_vol := autoVol  ]);
function([ name := "fun_ovAall", input := { "ov_A", "ov_A_eclipse" }, auto_vol := autoVol ]);
qgate([ name := "qga_copyNum_A", input := "fun_ovAall", value := copyNum, operator := "<" ]);

function([ name := "fun_constRate", type := "const", params := { 0.1 } ]);
function([ name := "fun_linearRate", input := { "qp_A" }, params := { 0.03 }, auto_vol := autoVol  ]);

oriv([ name := "ov_A"
	, copy_controls := {"cc_A"}
	, gate := "qga_copyNum_A"
	//, rate_fun := "fun_constRate"
	, eclipse_marker := "ov_A_eclipse"
	, eclipse := true
]);

partition_system([ name := "part_A", gate := partitionGate, fraction := partFraction, p := partP, vol_scaling := volScaling ]);

qplasmid([ name := "qp_A"
	, partition_system := "part_A"
	, oriVs := {"ov_A"}
	, copy_controls := {"cc_A"}
	, eclipse := { 5.0, 0.5 }
	, eclipse_marker := "qp_A_eclipse"
]);


//------------ WORLD CONTROL -----------------------
//---placers
cell_placer([ name := "cp_A", cell_types := { "cell_A" }, amount := 1.0, coords := [ r := 300.0 ] ]);


//------------ VISUALS -----------------------
function([ name := "fun_qpA", input := {"qp_A"}, auto_vol := autoVol ]);
function([ name := "fun_logPlas", input := {"fun_qpA"}, type := "log", params := {2.0}, auto_vol := "none" ]);
cell_colour([ name := "ccol_green", gate := "qp_A", target := "fun_logPlas", rgb := _green, scale := 0.5 ]);

function([ name := "fun_qpA_eclipse", input := {"qp_A_eclipse"}, auto_vol := autoVol ]);
function([ name := "fun_logEclipse", input := {"fun_qpA_eclipse"}, type := "log", params := {2.0}, auto_vol := "none" ]);
cell_colour([ name := "ccol_red", gate := "qp_A_eclipse", target := "fun_logEclipse", scale := 0.5, rgb := _red ]);

//---
cells_plot([ name := "cplt_plasRange", fields := { "fun_qpAall" } , stats := {"avg", "min", "max"} ]);
//cells_plot([ name := "cplt_ovRange", fields := { "fun_ovAall" } , stats := {"avg", "min", "max"} ]);
//cells_plot([ name := "cplt_eclipseRange", fields := { "fun_qpA_eclipse" } , stats := {"avg", "min", "max"} ]);

cells_plot([ name := "cplt_plas", fields := { "fun_qpA", "fun_qpA_eclipse", "fun_qpAall" } , stats := {"avg"} ]);

function([ name := "fun_partA", input := {"part_A"}, auto_vol := autoVol ]);
//cells_plot([ name := "cplt_comp", fields := { "fun_qpA", "fun_ovA", "fun_partA" } , stats := {"max"} ]);

function([ name := "fun_partA_eclipse", input := {"_part_A_eclipse"}, auto_vol := autoVol ]);
//cells_plot([ name := "cplt_compEclipse", fields := { "fun_qpA_eclipse", "fun_ovA_eclipse", "fun_partA_eclipse" } , stats := {"max"} ]);
//cells_plot([ name := "cplt_compRaw", fields := { "qp_A_eclipse", "ov_A_eclipse", "_part_A_eclipse" } , stats := {"max"} ]);

function([ name := "fun_ovA", input := {"ov_A"}, auto_vol := autoVol ]);
function([ name := "fun_ovA_eclipse", input := {"ov_A_eclipse"}, auto_vol := autoVol ]);
//cells_plot([ name := "cplt_oriV", fields := { "fun_ovA", "fun_ovA_eclipse", "fun_ovAall" } , stats := {"max"} ]);

cells_plot([ name := "cplt_division", fields := { "_em_division", "_volume" } , stats := {"avg"} ]);

function([ name := "fun_raw", input := { "qp_A", "qp_A_eclipse" } ]);
//cells_plot([ name := "cplt_plasRaw", fields := { "qp_A", "qp_A_eclipse", "fun_raw" } , stats := {"avg"} ]);

//cells_plot([ name := "cplt_rate", fields := { "fun_linearRate" } , stats := {"avg"} ]);
cells_plot([ name := "cplt_colour", fields := { "fun_logPlas" } , stats := {"avg"} ]);
