/*To test the historic element, fields: target, delay and ini_value. Reporting a qplasmid that changes in time (increase due to replication and decrease due to cell division)
A series of historic elements report the presence of the qplasmid with different delays, both as absolute amount and concentration, both the active copies and the eclipse ones
Syncrhonized cells for easier test

To test:
 - Select either the amount or the concentration plots
 - Make the copy control based on concentration or amount with selectedFun 
*/

include gro3

//params
iniCopies := 1.0;
copyNum := 100.0;
bEclipse := true;


selectedForColour := "h_qpA_1";

selectedFun := "fun_totalA";
//selectedFun := "fun_copyNumA";

selectedStrain := "str_synchro";
//selectedStrain := "str_custom";

global_params([ seed := 653999, show_plots := true ]);


//----------------------BIOCIRCUITS---------------------------
//---cells
bplasmid([ name := "bp_die", loss_prob := 1.0 ]);
bgate([ name := "bga_die", input := {"-bp_die"} ]);
strain([ name := "str_custom", death_gate := "bga_die", growth_rate := {  0.005, 0.0 }, death_threshold := 10.0, division_fraction := 0.5 ]);	
strain([ name := "str_synchro", growth_rate := {  0.005, 0.0 }, ini_vol := 2.5, division_vol := 3.2, division_fraction := 0.5 ]);	

cell_type([ name := "cell_A"
	, strain := selectedStrain
	, bplasmids := {"bp_die"} 
	, qplasmids := {"qp_A"} 
	, qplasmid_amounts := { iniCopies }
	//, qplasmids_as_concs := false
]);

//---plasmids
qplasmid([ name := "qp_A"
	, oriVs := {"ov_A"}
	//, partition := "part_A"
	, eclipse := { 4.0, 0.1 } 
	, eclipse_marker := "qpA_eclipse"
]);


//---replication
function([ name := "fun_totalA", input := { "qp_A", "qpA_eclipse" } ]);
function([ name := "fun_copyNumA", input := { "qp_A", "qpA_eclipse" }, auto_vol := "division" ]);

qgate([ name := "qga_copyNumA", input := selectedFun, value := copyNum, operator := "<" ]);
function([ name := "fun_rate", type := "const", params := {0.01} ]);
oriv([ name := "ov_A", gate := "qga_copyNumA", rate_fun := "fun_rate", eclipse := bEclipse ]);

//partition_system([ name := "part_A", fraction := 0.5 ]);


//---odes
function([ name := "fun_qpA_conc", input := { "qp_A" }, auto_vol := "division" ]);
function([ name := "fun_qpAeclipse_conc", input := { "qpA_eclipse" }, auto_vol := "division" ]);

historic([ name := "h_qpA_1", target := "qp_A", delay := 5.0 ]);
historic([ name := "h_qpA_2", target := "qp_A", delay := 10.0 ]);
historic([ name := "h_qpA_1_conc", target := "fun_qpA_conc", delay := 5.0 ]);
historic([ name := "h_qpA_2_conc", target := "fun_qpA_conc", delay := 10.0 ]);

historic([ name := "h_eclipse_3", target := "qpA_eclipse", delay := 5.0  ]);
historic([ name := "h_eclipse_4", target := "qpA_eclipse", delay := 10.0 ]);
historic([ name := "h_eclipse_3_conc", target := "fun_qpAeclipse_conc", delay := 5.0  ]);
historic([ name := "h_eclipse_4_conc", target := "fun_qpAeclipse_conc", delay := 10.0 ]);

//------------ WORLD CONTROL -----------------------
//---placers
cell_placer([ name := "cp_A", cell_types := { "cell_A" }, amount := 1.0, coords := [ r := 100.0 ] ]);


//------------ VISUALS -----------------------
bgate([ name := "bga_qpA", input := {"qp_A"} ]);
function([ name := "fun_qpAlog", input := {"qp_A"}, type := "log", params := {10.0} ]);
cell_colour([ name := "ccol_red", gate := "bga_qpA", rgb := _red, target := "fun_qpAlog", scale := 0.5 ]);

bgate([ name := "bga_h", input := {selectedForColour} ]);
function([ name := "fun_h", input := {selectedForColour}, type := "log", params := {10.0} ]);
cell_colour([ name := "ccol_green", gate := "bga_h", rgb := _green, target := "fun_h", scale := 0.5 ]);

//---
plot([ name := "plot_amounts", fields := { "qp_A", "qpA_eclipse", "fun_totalA" }, stats := {"avg"} ]);
plot([ name := "plot_concs", fields := { "fun_qpA_conc", "fun_qpAeclipse_conc", "fun_copyNumA" }, stats := {"avg"} ]);

//plot([ name := "plot_Aselect", fields := { selectedForColour }, stats := "avg" ]);
//plot([ name := "plot_all12", fields := {"qp_A", "h_qpA_1", "h_qpA_2" }, stats := "avg" ]);
//plot([ name := "plot_all34", fields := { "qpA_eclipse", "h_eclipse_3", "h_eclipse_4" }, stats := "avg" ]);
plot([ name := "plot_all12_conc", fields := {"fun_qpA_conc", "h_qpA_1_conc", "h_qpA_2_conc" }, stats := "avg" ]);
plot([ name := "plot_all34_conc", fields := {  "fun_qpAeclipse_conc", "h_eclipse_3_conc", "h_eclipse_4_conc" }, stats := "avg" ]);
